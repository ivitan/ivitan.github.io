<!DOCTYPE html><html><head><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-144334903-2","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js"></script><script data-ad-client="ca-pub-9318335501008303" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><meta charset="utf-8"><meta name="sogou_site_verification" content="ZjNrHOGj7T"><link rel="canonical" href="https://ivitan.com/posts/SQL-Command.html"><title>SQL 经典语句 - 楊咩阿</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#f45a8d"><meta name="keywords" content="SQL"><meta name="baidu-site-verification" content="code-BrguQlsdqJ"><meta name="description" content="经典SQL语句大全"><meta property="og:type" content="article"><meta property="og:title" content="SQL 经典语句"><meta property="og:url" content="https://ivitan.com/posts/SQL-Command.html"><meta property="og:site_name" content="楊咩阿"><meta property="og:description" content="经典SQL语句大全"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2018-03-24T15:43:05.000Z"><meta property="article:modified_time" content="2021-08-11T07:58:51.119Z"><meta property="article:author" content="VITAN"><meta property="article:tag" content="SQL"><meta name="twitter:card" content="summary"><link rel="alternate" type="application/atom+xml" title="楊咩阿" href="/xml/atom.xml"><link rel="shortcut icon" href="/img/favicon.svg"><link rel="stylesheet" href="/css/style.css?v=1.8.5"><script>window.lazyScripts=[]</script><meta name="generator" content="Hexo 4.2.1"></head><body><div id="loading" class="active"></div><aside id="menu" class="hide"><div class="inner flex-row-vertical"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off"><i class="icon icon-lg icon-close"></i></a><div class="brand-wrap" style="background-image:url(/img/brand.png)"><div class="brand"><a href="/" class="avatar waves-effect waves-circle waves-light"><img src="/img/ivitan.png"></a><hgroup class="introduce"><h5 class="nickname">VITAN</h5><a href="mailto:vitanyeung@gmail.com" title="vitanyeung@gmail.com" class="mail">vitanyeung@gmail.com</a></hgroup></div></div><div class="scroll-wrap flex-col"><ul class="nav"><li class="waves-block waves-effect"><a href="/"><i class="icon icon-lg icon-home"></i> 首页</a></li><li class="waves-block waves-effect"><a href="/archives"><i class="icon icon-lg icon-archives"></i> 归档</a></li><li class="waves-block waves-effect"><a href="/tags"><i class="icon icon-lg icon-tags"></i> 标签</a></li><li class="waves-block waves-effect"><a href="/about"><i class="icon icon-lg icon-user"></i> 关于</a></li><li class="waves-block waves-effect"><a href="https://github.com/ivitan" target="_blank"><i class="icon icon-lg icon-github-alt"></i> Github</a></li></ul></div></div></aside><main id="main"><header class="top-header" id="header"><div class="flex-row"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle"><i class="icon icon-lg icon-navicon"></i></a><div class="flex-col header-title ellipsis">SQL 经典语句</div><div class="search-wrap" id="search-wrap"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back"><i class="icon icon-lg icon-chevron-left"></i> </a><input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字"> <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search"><i class="icon icon-lg icon-search"></i></a></div></div></header><header class="content-header post-header"><div class="container fade-scale"><h1 class="title">SQL 经典语句</h1><h5 class="subtitle"><time datetime="2018-03-24T15:43:05.000Z" itemprop="datePublished" class="page-time">2018-03-24</time><ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Database/">Database</a></li></ul></h5></div></header><div class="container body-wrap"><aside class="post-widget"><nav class="post-toc-wrap post-toc-shrink" id="post-toc"><h4>TOC</h4><ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#基础"><span class="post-toc-number">1.</span> <span class="post-toc-text">基础</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#备份sql-server"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">备份sql server</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#根据已有的表创建新表："><span class="post-toc-number">1.2.</span> <span class="post-toc-text">根据已有的表创建新表：</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#几个简单的基本的-SQL-语句"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">几个简单的基本的 SQL 语句</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#几个高级查询运算词"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">几个高级查询运算词</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#使用外连接"><span class="post-toc-number">1.5.</span> <span class="post-toc-text">使用外连接</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#分组-Group-by"><span class="post-toc-number">1.6.</span> <span class="post-toc-text">分组:Group by</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#提升"><span class="post-toc-number">2.</span> <span class="post-toc-text">提升</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#第二部分"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">第二部分</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#第三部分"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">第三部分</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#第四部分"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">第四部分</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#第五部分"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">第五部分</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#数据开发-经典"><span class="post-toc-number">3.</span> <span class="post-toc-text">数据开发-经典</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#字符串函数-长度与分析用"><span class="post-toc-number">4.</span> <span class="post-toc-text">字符串函数 长度与分析用</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#常识"><span class="post-toc-number">5.</span> <span class="post-toc-text">常识</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#SQLServer2000同步复制技术实现步骤"><span class="post-toc-number">6.</span> <span class="post-toc-text">SQLServer2000同步复制技术实现步骤</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#预备工作"><span class="post-toc-number">6.1.</span> <span class="post-toc-text">预备工作</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#正式配置"><span class="post-toc-number">6.2.</span> <span class="post-toc-text">正式配置</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#配置发布服务器"><span class="post-toc-number">6.2.1.</span> <span class="post-toc-text">配置发布服务器</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#创建出版物"><span class="post-toc-number">6.2.2.</span> <span class="post-toc-text">创建出版物</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#大致的处理步"><span class="post-toc-number">6.3.</span> <span class="post-toc-text">大致的处理步</span></a></li></ol></li></ol></nav></aside><article id="post-SQL-Command" class="post-article article-type-post fade" itemprop="blogPost"><div class="post-card"><h1 class="post-card-title">SQL 经典语句</h1><div class="post-meta"><time class="post-time" title="2018-03-24 23:43:05" datetime="2018-03-24T15:43:05.000Z" itemprop="datePublished"><i class="icon icon-calendar"></i> 2018-03-24</time><ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Database/">Database</a></li></ul><span id="busuanzi_container_page_pv" title="文章总阅读量" style="display:none"><i class="icon icon-eye" style="padding:0 .3em"></i><span id="busuanzi_value_page_pv"></span></span></div><div class="post-content" id="post-content" itemprop="postContent"><p>经典SQL语句大全</p><a id="more"></a><h1 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h1><p>创建数据库</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="keyword">database</span>-<span class="keyword">name</span></span><br></pre></td></tr></table></figure><p>删除数据库</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">database</span> dbname</span><br></pre></td></tr></table></figure><h2 id="备份sql-server"><a href="#备份sql-server" class="headerlink" title="备份sql server"></a>备份sql server</h2><p>创建备份数据的 device</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> <span class="keyword">master</span></span><br><span class="line">EXEC sp_addumpdevice <span class="string">'disk'</span>, <span class="string">'testBack'</span>, <span class="string">'c:\mssql7backup\MyNwind_1.dat'</span></span><br></pre></td></tr></table></figure><p>开始备份<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BACKUP</span> <span class="keyword">DATABASE</span> pubs <span class="keyword">TO</span> testBack</span><br><span class="line">创建新表</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tabname(col1 type1 [<span class="keyword">not</span> <span class="literal">null</span>] [primary <span class="keyword">key</span>],col2 type2 [<span class="keyword">not</span> <span class="literal">null</span>],..)</span><br></pre></td></tr></table></figure><p></p><h2 id="根据已有的表创建新表："><a href="#根据已有的表创建新表：" class="headerlink" title="根据已有的表创建新表："></a>根据已有的表创建新表：</h2><blockquote><p>A：create table tab_new like tab_old (使用旧表创建新表)<br>B：create table tab_new as select col1,col2… from tab_old definition only</p></blockquote><p>删除新表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> tabname</span><br></pre></td></tr></table></figure><p>增加一个列</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Alter</span> <span class="keyword">table</span> tabname <span class="keyword">add</span> <span class="keyword">column</span> <span class="keyword">col</span> <span class="keyword">type</span></span><br></pre></td></tr></table></figure><p>注：列增加后将不能删除。DB2中列加上后数据类型也不能改变，唯一能改变的是增加varchar类型的长度。</p><p>添加主键</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Alter</span> <span class="keyword">table</span> tabname <span class="keyword">add</span> primary <span class="keyword">key</span>(<span class="keyword">col</span>)</span><br></pre></td></tr></table></figure><p>说明：删除主键： Alter table tabname drop primary key(col)</p><p>创建索引</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> [<span class="keyword">unique</span>] <span class="keyword">index</span> idxname <span class="keyword">on</span> tabname(<span class="keyword">col</span>….)</span><br></pre></td></tr></table></figure><p>删除索引：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">index</span> idxname</span><br></pre></td></tr></table></figure><p>注：索引是不可更改的，想更改必须删除重新建。</p><p>创建视图</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> viewname <span class="keyword">as</span> <span class="keyword">select</span> <span class="keyword">statement</span></span><br></pre></td></tr></table></figure><p>删除视图</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">view</span> viewname</span><br></pre></td></tr></table></figure><h2 id="几个简单的基本的-SQL-语句"><a href="#几个简单的基本的-SQL-语句" class="headerlink" title="几个简单的基本的 SQL 语句"></a>几个简单的基本的 SQL 语句</h2><p>语句</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">选择：<span class="keyword">select</span> * <span class="keyword">from</span> table1 <span class="keyword">where</span> 范围</span><br><span class="line">插入：<span class="keyword">insert</span> <span class="keyword">into</span> table1(field1,field2) <span class="keyword">values</span>(value1,value2)</span><br><span class="line">删除：<span class="keyword">delete</span> <span class="keyword">from</span> table1 <span class="keyword">where</span> 范围</span><br><span class="line">更新：<span class="keyword">update</span> table1 <span class="keyword">set</span> field1=value1 <span class="keyword">where</span> 范围</span><br><span class="line">查找：<span class="keyword">select</span> * <span class="keyword">from</span> table1 <span class="keyword">where</span> field1 <span class="keyword">like</span> ’%value1%’ <span class="comment">---like的语法很精妙，查资料!</span></span><br><span class="line">排序：<span class="keyword">select</span> * <span class="keyword">from</span> table1 <span class="keyword">order</span> <span class="keyword">by</span> field1,field2 [<span class="keyword">desc</span>]</span><br><span class="line">总数：<span class="keyword">select</span> <span class="keyword">count</span> <span class="keyword">as</span> totalcount <span class="keyword">from</span> table1</span><br><span class="line">求和：<span class="keyword">select</span> <span class="keyword">sum</span>(field1) <span class="keyword">as</span> sumvalue <span class="keyword">from</span> table1</span><br><span class="line">平均：<span class="keyword">select</span> <span class="keyword">avg</span>(field1) <span class="keyword">as</span> avgvalue <span class="keyword">from</span> table1</span><br><span class="line">最大：<span class="keyword">select</span> <span class="keyword">max</span>(field1) <span class="keyword">as</span> maxvalue <span class="keyword">from</span> table1</span><br><span class="line">最小：<span class="keyword">select</span> <span class="keyword">min</span>(field1) <span class="keyword">as</span> <span class="keyword">minvalue</span> <span class="keyword">from</span> table1</span><br></pre></td></tr></table></figure><h2 id="几个高级查询运算词"><a href="#几个高级查询运算词" class="headerlink" title="几个高级查询运算词"></a>几个高级查询运算词</h2><p>UNION 运算符通过组合其他两个结果表（例如 TABLE1 和 TABLE2）并消去表中任何重复行而派生出一个结果表。当 ALL 随 UNION 一起使用时（即 UNION ALL），不消除重复行。两种情况下，派生表的每一行不是来自 TABLE1 就是来自 TABLE2。</p><p>EXCEPT 运算符通过包括所有在 TABLE1 中但不在 TABLE2 中的行并消除所有重复行而派生出一个结果表。当 ALL 随 EXCEPT 一起使用时 (EXCEPT ALL)，不消除重复行。</p><p><code>INTERSECT</code> 运算符通过只包括 TABLE1 和 TABLE2 中都有的行并消除所有重复行而派生出一个结果表。当 ALL 随 INTERSECT 一起使用时 (INTERSECT ALL)，不消除重复行。</p><p>注：使用运算词的几个查询结果行必须是一致的。</p><h2 id="使用外连接"><a href="#使用外连接" class="headerlink" title="使用外连接"></a>使用外连接</h2><p>left （outer） join</p><ul><li>左外连接（左连接）：结果集几包括连接表的匹配行，也包括左连接表的所有行。</li><li>SQL: select a.a, a.b, a.c, b.c, b.d, b.f from a LEFT OUT JOIN b ON a.a = b.c</li></ul><p>right （outer） join<br>右外连接(右连接)：结果集既包括连接表的匹配连接行，也包括右连接表的所有行。</p><p>full/cross （outer） join<br>全外连接：不仅包括符号连接表的匹配行，还包括两个连接表中的所有记录。</p><h2 id="分组-Group-by"><a href="#分组-Group-by" class="headerlink" title="分组:Group by"></a>分组:Group by</h2><p>一张表，一旦分组完成后，查询后只能得到组相关的信息。</p><p>组相关的信息<br>统计信息） count,sum,max,min,avg 分组的标准)SQLServer中分组时：不能以text,ntext,image类型的字段作为分组依据,在selecte统计函数中的字段，不能和普通的字段放在一起对数据库进行操作</p><p>分离数据库<br>sp_detach_db; 附加数据库：sp_attach_db 后接表明，附加需要完整的路径名</p><p>如何修改数据: 库的名称</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sp_renamedb 'old_name', 'new_name'</span><br></pre></td></tr></table></figure><h1 id="提升"><a href="#提升" class="headerlink" title="提升"></a>提升</h1><p>复制表(只复制结构,源表名：a 新表名：b)</p><ul><li>法一：<code>select * into b from a where 1&lt;&gt;1</code>（仅用于SQlServer）</li><li>法二：<code>select top 0 * into b from a</code></li></ul><p>拷贝表(拷贝数据,源表名：a 目标表名：b)</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> b(a, b, c) <span class="keyword">select</span> d,e,f <span class="keyword">from</span> b</span><br></pre></td></tr></table></figure><p>跨数据库之间表的拷贝(具体数据使用绝对路径)</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> b(a, b, c) <span class="keyword">select</span> d,e,f <span class="keyword">from</span> b <span class="keyword">in</span> ‘具体数据库’ <span class="keyword">where</span> 条件</span><br></pre></td></tr></table></figure><ul><li>例子：..from b in ‘“&amp;Server.MapPath(“.”)&amp;”\data.mdb” &amp;”‘ where..</li></ul><p>子查询(表名1：a 表名2：b)</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a,b,c <span class="keyword">from</span> a <span class="keyword">where</span> a <span class="keyword">IN</span> (<span class="keyword">select</span> d <span class="keyword">from</span> b )</span><br></pre></td></tr></table></figure><ul><li>或者<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a,b,c <span class="keyword">from</span> a <span class="keyword">where</span> a <span class="keyword">IN</span> (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br></pre></td></tr></table></figure></li></ul><p>显示文章、提交人和最后回复时间</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.title,a.username,b.adddate <span class="keyword">from</span> <span class="keyword">table</span> a,(<span class="keyword">select</span> <span class="keyword">max</span>(adddate) adddate <span class="keyword">from</span> <span class="keyword">table</span> <span class="keyword">where</span> table.title=a.title) b</span><br></pre></td></tr></table></figure><p>外连接查询(表名1：a 表名2：b)</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.a, a.b, a.c, b.c, b.d, b.f <span class="keyword">from</span> a <span class="keyword">LEFT</span> <span class="keyword">OUT</span> <span class="keyword">JOIN</span> b <span class="keyword">ON</span> a.a = b.c</span><br></pre></td></tr></table></figure><h2 id="第二部分"><a href="#第二部分" class="headerlink" title="第二部分"></a>第二部分</h2><p>在线视图查询(表名1：a )</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`<span class="keyword">select</span> * <span class="keyword">from</span> (<span class="keyword">SELECT</span> a,b,c <span class="keyword">FROM</span> a) T <span class="keyword">where</span> t.a &gt; <span class="number">1</span></span><br></pre></td></tr></table></figure><p>between的用法,between限制查询数据范围时包括了边界值,not between不包括</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> table1 <span class="keyword">where</span> <span class="built_in">time</span> <span class="keyword">between</span> time1 <span class="keyword">and</span> time2</span><br><span class="line"><span class="keyword">select</span> a,b,c, <span class="keyword">from</span> table1 <span class="keyword">where</span> a <span class="keyword">not</span> <span class="keyword">between</span> 数值<span class="number">1</span> <span class="keyword">and</span> 数值<span class="number">2</span></span><br></pre></td></tr></table></figure><p>in 的使用方法</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> table1 <span class="keyword">where</span> a [<span class="keyword">not</span>] <span class="keyword">in</span> (‘值<span class="number">1</span>’,’值<span class="number">2</span>’,’值<span class="number">4</span>’,’值<span class="number">6</span>’)</span><br></pre></td></tr></table></figure><p>两张关联表，删除主表中已经在副表中没有的信息</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> table1 <span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span> ( <span class="keyword">select</span> * <span class="keyword">from</span> table2 <span class="keyword">where</span> table1.field1=table2.field1 )</span><br></pre></td></tr></table></figure><p>四表联查问题</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> a <span class="keyword">left</span> <span class="keyword">inner</span> <span class="keyword">join</span> b <span class="keyword">on</span> a.a=b.b <span class="keyword">right</span> <span class="keyword">inner</span> <span class="keyword">join</span> c <span class="keyword">on</span> a.a=c.c <span class="keyword">inner</span> <span class="keyword">join</span> d <span class="keyword">on</span> a.a=d.d <span class="keyword">where</span> .....</span><br></pre></td></tr></table></figure><p>日程安排提前五分钟提醒</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SQL: <span class="keyword">select</span> * <span class="keyword">from</span> 日程安排 <span class="keyword">where</span> <span class="keyword">datediff</span>(<span class="string">'minute'</span>,f开始时间,<span class="keyword">getdate</span>())&gt;<span class="number">5</span></span><br></pre></td></tr></table></figure><p>一条sql 语句搞定数据库分页</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> top <span class="number">10</span> b.* <span class="keyword">from</span> (<span class="keyword">select</span> top <span class="number">20</span> 主键字段,排序字段 <span class="keyword">from</span> 表名 <span class="keyword">order</span> <span class="keyword">by</span> 排序字段 <span class="keyword">desc</span>) a,表名 b <span class="keyword">where</span> b.主键字段 = a.主键字段 <span class="keyword">order</span> <span class="keyword">by</span> a.排序字段</span><br></pre></td></tr></table></figure><ul><li>具体实现：</li><li>关于数据库分页</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> @<span class="keyword">start</span> <span class="built_in">int</span>,@<span class="keyword">end</span> <span class="built_in">int</span></span><br><span class="line">@<span class="keyword">sql</span>  <span class="keyword">nvarchar</span>(<span class="number">600</span>)</span><br><span class="line"><span class="keyword">set</span> @<span class="keyword">sql</span>=’<span class="keyword">select</span> top’+<span class="keyword">str</span>(@<span class="keyword">end</span>-@<span class="keyword">start</span>+<span class="number">1</span>)+’+<span class="keyword">from</span> T <span class="keyword">where</span> rid <span class="keyword">not</span> <span class="keyword">in</span>(<span class="keyword">select</span> top’+<span class="keyword">str</span>(@<span class="keyword">str</span><span class="number">-1</span>)+’Rid <span class="keyword">from</span> T <span class="keyword">where</span> Rid&gt;<span class="number">-1</span>)’</span><br><span class="line">exec sp_executesql @<span class="keyword">sql</span></span><br></pre></td></tr></table></figure><ul><li>注意：在top后不能直接跟一个变量，所以在实际应用中只有这样的进行特殊的处理。Rid为一个标识列，如果top后还有具体的字段，这样做是非常有好处的。因为这样可以避免 top的字段如果是逻辑索引的，查询的结果后实际表中的不一致（逻辑索引中的数据有可能和数据表中的不一致，而查询时如果处在索引则首先查询索引）</li></ul><h2 id="第三部分"><a href="#第三部分" class="headerlink" title="第三部分"></a>第三部分</h2><p>前10条记录</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> top <span class="number">10</span> * <span class="keyword">form</span> table1 <span class="keyword">where</span> 范围</span><br></pre></td></tr></table></figure><p>选择在每一组b值相同的数据中对应的a最大的记录的所有信息(类似这样的用法可以用于论坛每月排行榜,每月热销产品分析,按科目成绩排名,等等.)</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a,b,c <span class="keyword">from</span> tablename ta <span class="keyword">where</span> a=(<span class="keyword">select</span> <span class="keyword">max</span>(a) <span class="keyword">from</span> tablename tb <span class="keyword">where</span> tb.b=ta.b)</span><br></pre></td></tr></table></figure><p>包括所有在 TableA 中但不在 TableB和TableC 中的行并消除所有重复行而派生出一个结果表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">select</span> a <span class="keyword">from</span> tableA ) <span class="keyword">except</span> (<span class="keyword">select</span> a <span class="keyword">from</span> tableB) <span class="keyword">except</span> (<span class="keyword">select</span> a <span class="keyword">from</span> tableC)</span><br></pre></td></tr></table></figure><p>随机取出10条数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> top <span class="number">10</span> * <span class="keyword">from</span> tablename <span class="keyword">order</span> <span class="keyword">by</span> newid()</span><br></pre></td></tr></table></figure><p>随机选择记录</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> newid()</span><br></pre></td></tr></table></figure><p>删除重复记录</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> tablename <span class="keyword">where</span> <span class="keyword">id</span> <span class="keyword">not</span> <span class="keyword">in</span> (<span class="keyword">select</span> <span class="keyword">max</span>(<span class="keyword">id</span>) <span class="keyword">from</span> tablename <span class="keyword">group</span> <span class="keyword">by</span> col1,col2,...)</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> * <span class="keyword">into</span> temp <span class="keyword">from</span> tablename</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> tablename</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tablename <span class="keyword">select</span> * <span class="keyword">from</span> temp</span><br></pre></td></tr></table></figure><ul><li>评价：这种操作牵连大量的数据的移动，这种做法不适合大容量但数据操作</li><li>例如:在一个外部表中导入数据，由于某些原因第一次只导入了一部分，但很难判断具体位置，这样只有在下一次全部导入，这样也就产生好多重复的字段，怎样删除重复字段</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table tablename</span><br></pre></td></tr></table></figure><ul><li>加一个自增列</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add  column_b int identity(1,1)</span><br><span class="line"> <span class="keyword">delete</span> <span class="keyword">from</span> tablename <span class="keyword">where</span> column_b <span class="keyword">not</span> <span class="keyword">in</span>(</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">max</span>(column_b)  <span class="keyword">from</span> tablename <span class="keyword">group</span> <span class="keyword">by</span> column1,column2,...)</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tablename <span class="keyword">drop</span> <span class="keyword">column</span> column_b</span><br></pre></td></tr></table></figure><h2 id="第四部分"><a href="#第四部分" class="headerlink" title="第四部分"></a>第四部分</h2><p>列出数据库里所有的表名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">name</span> <span class="keyword">from</span> sysobjects <span class="keyword">where</span> <span class="keyword">type</span>=<span class="string">'U'</span> // U代表用户</span><br></pre></td></tr></table></figure><p>列出表里的所有的列名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">name</span> <span class="keyword">from</span> syscolumns <span class="keyword">where</span> <span class="keyword">id</span>=object_id(<span class="string">'TableName'</span>)</span><br></pre></td></tr></table></figure><p>列示type、vender、pcs字段，以type字段排列，case可以方便地实现多重选择，类似select 中的case</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">type</span>,<span class="keyword">sum</span>(<span class="keyword">case</span> vender <span class="keyword">when</span> <span class="string">'A'</span> <span class="keyword">then</span> pcs <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>),<span class="keyword">sum</span>(<span class="keyword">case</span> vender <span class="keyword">when</span> <span class="string">'C'</span> <span class="keyword">then</span> pcs <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>),<span class="keyword">sum</span>(<span class="keyword">case</span> vender <span class="keyword">when</span> <span class="string">'B'</span> <span class="keyword">then</span> pcs <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">FROM</span> tablename <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">type</span></span><br></pre></td></tr></table></figure><ul><li>显示结果：<blockquote><p>type vender pcs<br>电脑 A 1<br>电脑 A 1<br>光盘 B 2<br>光盘 A 2<br>手机 B 3<br>手机 C 3</p></blockquote></li></ul><p>初始化表table1</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> table1</span><br></pre></td></tr></table></figure><p>选择从10到15的记录</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> top <span class="number">5</span> * <span class="keyword">from</span> (<span class="keyword">select</span> top <span class="number">15</span> * <span class="keyword">from</span> <span class="keyword">table</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">id</span> <span class="keyword">asc</span>) table_别名 <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">id</span> <span class="keyword">desc</span></span><br></pre></td></tr></table></figure><ul><li>技巧</li><li>1=1，1=2的使用，在SQL语句组合时用的较多</li><li>“where 1=1” 是表示选择全部 “where 1=2”全部不选，如：</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">if @strWhere !=''</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @strSQL = <span class="string">'select count(*) as Total from ['</span> + @tblName + <span class="string">'] where '</span> + @strWhere</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @strSQL = <span class="string">'select count(*) as Total from ['</span> + @tblName + <span class="string">']'</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>我们可以直接写成</p><p>错误！未找到目录项。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> @strSQL = <span class="string">'select count(*) as Total from ['</span> + @tblName + <span class="string">'] where 1=1 安定 '</span>+ @strWhere <span class="number">2</span>、收缩数据库</span><br></pre></td></tr></table></figure><h2 id="第五部分"><a href="#第五部分" class="headerlink" title="第五部分"></a>第五部分</h2><ol><li>重建索引<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DBCC REINDEX</span><br><span class="line">DBCC INDEXDEFRAG</span><br></pre></td></tr></table></figure></li><li>收缩数据和日志<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DBCC SHRINKDB</span><br><span class="line">DBCC SHRINKFILE</span><br></pre></td></tr></table></figure></li><li>压缩数据库<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dbcc shrinkdatabase(dbname)</span><br></pre></td></tr></table></figure></li><li>转移数据库 给新用户以已存在用户权限<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exec sp_change_users_login 'update_one','newname','oldname'</span><br><span class="line">go</span><br></pre></td></tr></table></figure></li><li>检查备份集<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RESTORE</span> VERIFYONLY <span class="keyword">from</span> disk=<span class="string">'E:\dvbbs.bak'</span></span><br></pre></td></tr></table></figure></li><li>修复数据库<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">DATABASE</span> [dvbbs] <span class="keyword">SET</span> SINGLE_USER</span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line">DBCC CHECKDB(<span class="string">'dvbbs'</span>,repair_allow_data_loss) <span class="keyword">WITH</span> TABLOCK</span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">DATABASE</span> [dvbbs] <span class="keyword">SET</span> MULTI_USER</span><br><span class="line"><span class="keyword">GO</span></span><br></pre></td></tr></table></figure></li><li>日志清除<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> NOCOUNT <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">DECLARE</span> @LogicalFileName sysname,</span><br><span class="line"> @MaxMinutes <span class="built_in">INT</span>,</span><br><span class="line"> @NewSize <span class="built_in">INT</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">USE</span> tablename <span class="comment">-- 要操作的数据库名</span></span><br><span class="line"><span class="keyword">SELECT</span>  @LogicalFileName = <span class="string">'tablename_log'</span>, <span class="comment">-- 日志文件名</span></span><br><span class="line">@MaxMinutes = <span class="number">10</span>, <span class="comment">-- Limit on time allowed to wrap log.</span></span><br><span class="line"> @NewSize = <span class="number">1</span>  <span class="comment">-- 你想设定的日志文件的大小(M)</span></span><br><span class="line">Setup / initialize</span><br><span class="line"><span class="keyword">DECLARE</span> @OriginalSize <span class="built_in">int</span></span><br><span class="line"><span class="keyword">SELECT</span> @OriginalSize = <span class="keyword">size</span></span><br><span class="line"> <span class="keyword">FROM</span> sysfiles</span><br><span class="line"> <span class="keyword">WHERE</span> <span class="keyword">name</span> = @LogicalFileName</span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">'Original Size of '</span> + db_name() + <span class="string">' LOG is '</span> +</span><br><span class="line"> <span class="keyword">CONVERT</span>(<span class="built_in">VARCHAR</span>(<span class="number">30</span>),@OriginalSize) + <span class="string">' 8K pages or '</span> +</span><br><span class="line"> <span class="keyword">CONVERT</span>(<span class="built_in">VARCHAR</span>(<span class="number">30</span>),(@OriginalSize*<span class="number">8</span>/<span class="number">1024</span>)) + <span class="string">'MB'</span></span><br><span class="line"> <span class="keyword">FROM</span> sysfiles</span><br><span class="line"> <span class="keyword">WHERE</span> <span class="keyword">name</span> = @LogicalFileName</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> DummyTrans</span><br><span class="line"> (DummyColumn <span class="built_in">char</span> (<span class="number">8000</span>) <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">DECLARE</span> @Counter    <span class="built_in">INT</span>,</span><br><span class="line"> @StartTime DATETIME,</span><br><span class="line"> @TruncLog   <span class="built_in">VARCHAR</span>(<span class="number">255</span>)</span><br><span class="line"><span class="keyword">SELECT</span> @StartTime = <span class="keyword">GETDATE</span>(),</span><br><span class="line"> @TruncLog = <span class="string">'BACKUP LOG '</span> + db_name() + <span class="string">' WITH TRUNCATE_ONLY'</span></span><br><span class="line">DBCC SHRINKFILE (@LogicalFileName, @NewSize)</span><br><span class="line">EXEC (@TruncLog)</span><br><span class="line"><span class="comment">-- Wrap the log if necessary.</span></span><br><span class="line"><span class="keyword">WHILE</span> @MaxMinutes &gt; <span class="keyword">DATEDIFF</span> (mi, @StartTime, <span class="keyword">GETDATE</span>()) <span class="comment">-- time has not expired</span></span><br><span class="line"> <span class="keyword">AND</span> @OriginalSize = (<span class="keyword">SELECT</span> <span class="keyword">size</span> <span class="keyword">FROM</span> sysfiles <span class="keyword">WHERE</span> <span class="keyword">name</span> = @LogicalFileName)</span><br><span class="line"> <span class="keyword">AND</span> (@OriginalSize * <span class="number">8</span> /<span class="number">1024</span>) &gt; @NewSize</span><br><span class="line"> <span class="keyword">BEGIN</span> <span class="comment">-- Outer loop.</span></span><br><span class="line"><span class="keyword">SELECT</span> @Counter = <span class="number">0</span></span><br><span class="line"> <span class="keyword">WHILE</span>   ((@Counter &lt; @OriginalSize / <span class="number">16</span>) <span class="keyword">AND</span> (@Counter &lt; <span class="number">50000</span>))</span><br><span class="line"> <span class="keyword">BEGIN</span> <span class="comment">-- update</span></span><br><span class="line"> <span class="keyword">INSERT</span> DummyTrans <span class="keyword">VALUES</span> (<span class="string">'Fill Log'</span>) <span class="keyword">DELETE</span> DummyTrans</span><br><span class="line"> <span class="keyword">SELECT</span> @Counter = @Counter + <span class="number">1</span></span><br><span class="line"> <span class="keyword">END</span></span><br><span class="line"> EXEC (@TruncLog)</span><br><span class="line"> <span class="keyword">END</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">'Final Size of '</span> + db_name() + <span class="string">' LOG is '</span> +</span><br><span class="line"> <span class="keyword">CONVERT</span>(<span class="built_in">VARCHAR</span>(<span class="number">30</span>),<span class="keyword">size</span>) + <span class="string">' 8K pages or '</span> +</span><br><span class="line"> <span class="keyword">CONVERT</span>(<span class="built_in">VARCHAR</span>(<span class="number">30</span>),(<span class="keyword">size</span>*<span class="number">8</span>/<span class="number">1024</span>)) + <span class="string">'MB'</span></span><br><span class="line"> <span class="keyword">FROM</span> sysfiles</span><br><span class="line"> <span class="keyword">WHERE</span> <span class="keyword">name</span> = @LogicalFileName</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> DummyTrans</span><br><span class="line"><span class="keyword">SET</span> NOCOUNT <span class="keyword">OFF</span></span><br></pre></td></tr></table></figure></li><li>说明：更改某个表<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec sp_changeobjectowner 'tablename','dbo'</span><br></pre></td></tr></table></figure></li><li>存储更改全部表<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> dbo.User_ChangeObjectOwnerBatch</span><br><span class="line">@OldOwner <span class="keyword">as</span> <span class="keyword">NVARCHAR</span>(<span class="number">128</span>),</span><br><span class="line">@NewOwner <span class="keyword">as</span> <span class="keyword">NVARCHAR</span>(<span class="number">128</span>)</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">DECLARE</span> @<span class="keyword">Name</span>    <span class="keyword">as</span> <span class="keyword">NVARCHAR</span>(<span class="number">128</span>)</span><br><span class="line"><span class="keyword">DECLARE</span> @Owner   <span class="keyword">as</span> <span class="keyword">NVARCHAR</span>(<span class="number">128</span>)</span><br><span class="line"><span class="keyword">DECLARE</span> @OwnerName   <span class="keyword">as</span> <span class="keyword">NVARCHAR</span>(<span class="number">128</span>)</span><br><span class="line"><span class="keyword">DECLARE</span> curObject <span class="keyword">CURSOR</span> <span class="keyword">FOR</span></span><br><span class="line"><span class="keyword">select</span> <span class="string">'Name'</span>    = <span class="keyword">name</span>,</span><br><span class="line">   <span class="string">'Owner'</span>    = user_name(uid)</span><br><span class="line"><span class="keyword">from</span> sysobjects</span><br><span class="line"><span class="keyword">where</span> user_name(uid)=@OldOwner</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">name</span></span><br><span class="line"><span class="keyword">OPEN</span>   curObject</span><br><span class="line"><span class="keyword">FETCH</span> <span class="keyword">NEXT</span> <span class="keyword">FROM</span> curObject <span class="keyword">INTO</span> @<span class="keyword">Name</span>, @Owner</span><br><span class="line"><span class="keyword">WHILE</span>(@@FETCH_STATUS=<span class="number">0</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">if</span> @Owner=@OldOwner</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   <span class="keyword">set</span> @OwnerName = @OldOwner + <span class="string">'.'</span> + <span class="keyword">rtrim</span>(@<span class="keyword">Name</span>)</span><br><span class="line">   exec sp_changeobjectowner @OwnerName, @NewOwner</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- select @name,@NewOwner,@OldOwner</span></span><br><span class="line"><span class="keyword">FETCH</span> <span class="keyword">NEXT</span> <span class="keyword">FROM</span> curObject <span class="keyword">INTO</span> @<span class="keyword">Name</span>, @Owner</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line"><span class="keyword">close</span> curObject</span><br><span class="line"><span class="keyword">deallocate</span> curObject</span><br><span class="line"><span class="keyword">GO</span></span><br></pre></td></tr></table></figure></li><li>SQL SERVER中直接循环写入数据<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> @i <span class="built_in">int</span></span><br><span class="line"><span class="keyword">set</span> @i=<span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> @i&lt;<span class="number">30</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">test</span> (userid) <span class="keyword">values</span>(@i)</span><br><span class="line">    <span class="keyword">set</span> @i=@i+<span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></li></ol><ul><li>案例：有如下表，要求就裱中所有沒有及格的成績，在每次增長0.1的基礎上，使他們剛好及格:</li></ul><table><thead><tr><th align="left">Name</th><th align="left">score</th></tr></thead><tbody><tr><td align="left">Zhangshan</td><td align="left">80</td></tr><tr><td align="left">Lishi</td><td align="left">59</td></tr><tr><td align="left">Wangwu</td><td align="left">50</td></tr><tr><td align="left">Songquan</td><td align="left">69</td></tr></tbody></table><hr><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">while((<span class="keyword">select</span> <span class="keyword">min</span>(score) <span class="keyword">from</span> tb_table)&lt;<span class="number">60</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">update</span> tb_table <span class="keyword">set</span> score =score*<span class="number">1.01</span></span><br><span class="line"><span class="keyword">where</span> score&lt;<span class="number">60</span></span><br><span class="line"><span class="keyword">if</span>  (<span class="keyword">select</span> <span class="keyword">min</span>(score) <span class="keyword">from</span> tb_table)&gt;<span class="number">60</span></span><br><span class="line">  break</span><br><span class="line"> <span class="keyword">else</span></span><br><span class="line">    continue</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h1 id="数据开发-经典"><a href="#数据开发-经典" class="headerlink" title="数据开发-经典"></a>数据开发-经典</h1><ol><li>按姓氏笔画排序:<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Select</span> * <span class="keyword">From</span> TableName <span class="keyword">Order</span> <span class="keyword">By</span> CustomerName <span class="keyword">Collate</span> Chinese_PRC_Stroke_ci_as //从少到多</span><br></pre></td></tr></table></figure></li><li>数据库加密:<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">encrypt</span>(<span class="string">'原始密码'</span>)</span><br><span class="line"><span class="keyword">select</span> pwdencrypt(<span class="string">'原始密码'</span>)</span><br><span class="line"><span class="keyword">select</span> pwdcompare(<span class="string">'原始密码'</span>,<span class="string">'加密后密码'</span>) = <span class="number">1</span><span class="comment">--相同；否则不相同 encrypt('原始密码')</span></span><br><span class="line"><span class="keyword">select</span> pwdencrypt(<span class="string">'原始密码'</span>)</span><br><span class="line"><span class="keyword">select</span> pwdcompare(<span class="string">'原始密码'</span>,<span class="string">'加密后密码'</span>) = <span class="number">1</span><span class="comment">--相同；否则不相同</span></span><br></pre></td></tr></table></figure></li><li>取回表中字段:<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> @<span class="keyword">list</span> <span class="built_in">varchar</span>(<span class="number">1000</span>),</span><br><span class="line">@<span class="keyword">sql</span> <span class="keyword">nvarchar</span>(<span class="number">1000</span>)</span><br><span class="line"><span class="keyword">select</span> @<span class="keyword">list</span>=@<span class="keyword">list</span>+<span class="string">','</span>+b.name <span class="keyword">from</span> sysobjects a,syscolumns b <span class="keyword">where</span> a.id=b.id <span class="keyword">and</span> a.name=<span class="string">'表A'</span></span><br><span class="line"><span class="keyword">set</span> @<span class="keyword">sql</span>=<span class="string">'select '</span>+<span class="keyword">right</span>(@<span class="keyword">list</span>,<span class="keyword">len</span>(@<span class="keyword">list</span>)<span class="number">-1</span>)+<span class="string">' from 表A'</span></span><br><span class="line">exec (@<span class="keyword">sql</span>)</span><br></pre></td></tr></table></figure></li><li>查看硬盘分区:<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXEC master..xp_fixeddrives</span><br></pre></td></tr></table></figure></li><li>比较A,B表是否相等:<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if (<span class="keyword">select</span> <span class="keyword">checksum_agg</span>(binary_checksum(*)) <span class="keyword">from</span> A)</span><br><span class="line">     =</span><br><span class="line">    (<span class="keyword">select</span> <span class="keyword">checksum_agg</span>(binary_checksum(*)) <span class="keyword">from</span> B)</span><br><span class="line">print <span class="string">'相等'</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">print <span class="string">'不相等'</span></span><br></pre></td></tr></table></figure></li><li>杀掉所有的事件探察器进程:<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span> hcforeach <span class="keyword">CURSOR</span> <span class="keyword">GLOBAL</span> <span class="keyword">FOR</span> <span class="keyword">SELECT</span> <span class="string">'kill '</span>+<span class="keyword">RTRIM</span>(spid) <span class="keyword">FROM</span> master.dbo.sysprocesses</span><br><span class="line"><span class="keyword">WHERE</span> program_name <span class="keyword">IN</span>(<span class="string">'SQL profiler'</span>,N<span class="string">'SQL 事件探查器'</span>)</span><br><span class="line">EXEC sp_msforeach_worker <span class="string">'?'</span></span><br></pre></td></tr></table></figure></li><li>记录搜索:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">开头到N条记录</span><br><span class="line">Select Top N * From 表</span><br><span class="line">-------------------------------</span><br><span class="line">N到M条记录(要有主索引ID)</span><br><span class="line">Select Top M-N * From 表 Where ID in (Select Top M ID From 表) Order by ID   Desc</span><br><span class="line">----------------------------------</span><br><span class="line">N到结尾记录</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Select</span> Top N * <span class="keyword">From</span> 表 <span class="keyword">Order</span> <span class="keyword">by</span> <span class="keyword">ID</span> <span class="keyword">Desc</span></span><br></pre></td></tr></table></figure></li></ol><ul><li><p>案例</p><ul><li>例如1：一张表有一万多条记录，表的第一个字段 RecID 是自增长字段，写一个SQL语句， 找出表的第31到第40个记录。</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> top <span class="number">10</span> recid <span class="keyword">from</span> A <span class="keyword">where</span> recid <span class="keyword">not</span>  <span class="keyword">in</span>(<span class="keyword">select</span> top <span class="number">30</span> recid <span class="keyword">from</span> A)</span><br></pre></td></tr></table></figure><p>分析：如果这样写会产生某些问题，如果recid在表中存在逻辑索引。<code>select top 10 recid from A where……</code>是从索引中查找，而后面的<code>select top 30 recid from A</code>则在数据表中查找，这样由于索引中的顺序有可能和数据表中的不一致，这样就导致查询到的不是本来的欲得到的数据。</p></li><li><p>解决方案</p><ul><li>用<code>order by select top 30 recid from A order by ricid</code>如果该字段不是自增长，就会出现问题</li><li>在那个子查询中也加条件：<code>select top 30 recid from A where recid&gt;-1</code></li></ul></li><li><p>例2：查询表中的最后以条记录，并不知道这个表共有多少数据,以及表结构。</p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> @s = <span class="string">'select top 1 * from T   where pid not in (select top '</span> + <span class="keyword">str</span>(@<span class="keyword">count</span><span class="number">-1</span>) + <span class="string">' pid  from  T)'</span></span><br><span class="line">print @s      exec  sp_executesql  @s</span><br></pre></td></tr></table></figure><ol start="9"><li><p>获取当前数据库中的所有用户表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">Name</span> <span class="keyword">from</span> sysobjects <span class="keyword">where</span> xtype=<span class="string">'u'</span> <span class="keyword">and</span> <span class="keyword">status</span>&gt;=<span class="number">0</span></span><br></pre></td></tr></table></figure></li><li><p>获取某一个表的所有字段</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">name</span> <span class="keyword">from</span> syscolumns <span class="keyword">where</span> <span class="keyword">id</span>=object_id(<span class="string">'表名'</span>)</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">name</span> <span class="keyword">from</span> syscolumns <span class="keyword">where</span> <span class="keyword">id</span> <span class="keyword">in</span> (<span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> sysobjects <span class="keyword">where</span> <span class="keyword">type</span> = <span class="string">'u'</span> <span class="keyword">and</span> <span class="keyword">name</span> = <span class="string">'表名'</span>)</span><br></pre></td></tr></table></figure><p>两种方式的效果相同</p></li><li><p>查看与某一个表相关的视图、存储过程、函数</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.* <span class="keyword">from</span> sysobjects a, syscomments b <span class="keyword">where</span> a.id = b.id <span class="keyword">and</span> b.text <span class="keyword">like</span> <span class="string">'%表名%'</span></span><br></pre></td></tr></table></figure></li><li><p>查看当前数据库中所有存储过程</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">name</span> <span class="keyword">as</span> 存储过程名称 <span class="keyword">from</span> sysobjects <span class="keyword">where</span> xtype=<span class="string">'P'</span></span><br></pre></td></tr></table></figure></li><li><p>查询用户创建的所有数据库</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from master..sysdatabases D where sid not in(select sid from master..syslogins where name&#x3D;&#39;sa&#39;)</span><br></pre></td></tr></table></figure></li></ol><ul><li>或者<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> dbid, <span class="keyword">name</span> <span class="keyword">AS</span> DB_NAME <span class="keyword">from</span> master..sysdatabases <span class="keyword">where</span> <span class="keyword">sid</span> &lt;&gt; <span class="number">0x01</span></span><br></pre></td></tr></table></figure></li></ul><ol start="14"><li>查询某一个表的字段和数据类型<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> column_name,data_type <span class="keyword">from</span> information_schema.columns</span><br><span class="line"><span class="keyword">where</span> table_name = <span class="string">'表名'</span></span><br></pre></td></tr></table></figure></li><li>不同服务器数据库之间的数据操作</li></ol><ul><li><p>创建链接服务器</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exec sp_addlinkedserver   'ITSV ', ' ', 'SQLOLEDB ', '远程服务器名或ip地址 '</span><br><span class="line">exec sp_addlinkedsrvlogin  'ITSV ', 'false ',null, '用户名 ', '密码 '</span><br></pre></td></tr></table></figure><ul><li>查询示例</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> ITSV.数据库名.dbo.表名</span><br></pre></td></tr></table></figure><ul><li>导入示例</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">into</span> 表 <span class="keyword">from</span> ITSV.数据库名.dbo.表名</span><br></pre></td></tr></table></figure><ul><li>以后不再使用时删除链接服务器</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec sp_dropserver  'ITSV ', 'droplogins '</span><br></pre></td></tr></table></figure><ul><li>连接远程/局域网数据(openrowset/openquery/opendatasource)</li></ul><p>–1、openrowset</p><ul><li>查询示例</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> openrowset( <span class="string">'SQLOLEDB '</span>, <span class="string">'sql服务器名 '</span>; '用户名 '; '密码 ',数据库名.dbo.表名)</span><br></pre></td></tr></table></figure><ul><li>生成本地表</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">into</span> 表 <span class="keyword">from</span> openrowset( <span class="string">'SQLOLEDB '</span>, <span class="string">'sql服务器名 '</span>; '用户名 '; '密码 ',数据库名.dbo.表名)</span><br></pre></td></tr></table></figure><ul><li>把本地表导入远程表</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> openrowset( <span class="string">'SQLOLEDB '</span>, <span class="string">'sql服务器名 '</span>; '用户名 '; '密码 ',数据库名.dbo.表名)</span><br><span class="line"><span class="keyword">select</span> *<span class="keyword">from</span> 本地表</span><br></pre></td></tr></table></figure><ul><li>更新本地表</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> b</span><br><span class="line"><span class="keyword">set</span> b.列A=a.列A</span><br><span class="line"><span class="keyword">from</span> openrowset( <span class="string">'SQLOLEDB '</span>, <span class="string">'sql服务器名 '</span>; '用户名 '; '密码 ',数据库名.dbo.表名)as a inner join 本地表 b</span><br><span class="line">on a.column1=b.column1</span><br></pre></td></tr></table></figure><ul><li>openquery用法需要创建一个连接</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--首先创建一个连接创建链接服务器</span></span><br><span class="line">exec sp_addlinkedserver   'ITSV ', ' ', 'SQLOLEDB ', '远程服务器名或ip地址 '</span><br></pre></td></tr></table></figure><ul><li>查询</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">FROM</span> openquery(ITSV,  <span class="string">'SELECT *  FROM 数据库.dbo.表名 '</span>)</span><br></pre></td></tr></table></figure><p>–把本地表导入远程表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> openquery(ITSV,  <span class="string">'SELECT *  FROM 数据库.dbo.表名 '</span>)</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> 本地表</span><br></pre></td></tr></table></figure><ul><li>更新本地表</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">update b</span><br><span class="line">set b.列B&#x3D;a.列B</span><br><span class="line">FROM openquery(ITSV,  &#39;SELECT * FROM 数据库.dbo.表名 &#39;) as a</span><br><span class="line">inner join 本地表 b on a.列A&#x3D;b.列A</span><br></pre></td></tr></table></figure><ul><li>3、opendatasource/openrowset</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>   *</span><br><span class="line"><span class="keyword">FROM</span>   opendatasource( <span class="string">'SQLOLEDB '</span>,  <span class="string">'Data Source=ip/ServerName;User ID=登陆名;Password=密码 '</span> ).test.dbo.roy_ta</span><br></pre></td></tr></table></figure><ul><li>把本地表导入远程表</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> opendatasource( <span class="string">'SQLOLEDB '</span>,  <span class="string">'Data Source=ip/ServerName;User ID=登陆名;Password=密码 '</span>).数据库.dbo.表名</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> 本地表</span><br><span class="line"><span class="keyword">SQL</span> <span class="keyword">Server</span>基本函数</span><br><span class="line"><span class="keyword">SQL</span> <span class="keyword">Server</span>基本函数</span><br></pre></td></tr></table></figure></li></ul><h1 id="字符串函数-长度与分析用"><a href="#字符串函数-长度与分析用" class="headerlink" title="字符串函数 长度与分析用"></a>字符串函数 长度与分析用</h1><p>例子</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">datalength(Char_expr)</span><br></pre></td></tr></table></figure><p>返回字符串包含字符数,但不包含后面的空格</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">substring(expression,<span class="keyword">start</span>,<span class="keyword">length</span>)</span><br></pre></td></tr></table></figure><p>取子串，字符串的下标是从“1”，start为起始位置，length为字符串长度，实际应用中以len(expression)取得其长度</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">right(char_expr,int_expr)</span><br></pre></td></tr></table></figure><p>返回字符串右边第int_expr个字符，还用left于之相反</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">isnull( check_expression , replacement_value )</span><br></pre></td></tr></table></figure><p>如果check_expression為空，則返回replacement_value的值，不為空，就返回check_expression字符操作类</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Sp_addtype</span><br><span class="line"><span class="comment">--自定義數據類型</span></span><br></pre></td></tr></table></figure><p>例如：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXEC sp_addtype birthday, datetime, 'NULL'</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> nocount &#123;<span class="keyword">on</span>|<span class="keyword">off</span>&#125;</span><br></pre></td></tr></table></figure><p>使返回的结果中不包含有关受 Transact-SQL 语句影响的行数的信息。如果存储过程中包含的一些语句并不返回许多实际的数据，则该设置由于大量减少了网络流量，因此可显著提高性能。SET NOCOUNT 设置是在执行或运行时设置，而不是在分析时设置。</p><ul><li>SET NOCOUNT 为 ON 时，不返回计数（表示受 Transact-SQL 语句影响的行数）。</li><li>SET NOCOUNT 为 OFF 时，返回计数</li></ul><h1 id="常识"><a href="#常识" class="headerlink" title="常识"></a>常识</h1><p>SQL中<br>1.在SQL查询中：from后最多可以跟多少张表或视图：256<br>2. 在SQL语句中出现 Order by,查询时，先排序，后取<br>3. 在SQL中，一个字段的最大容量是8000，而对于nvarchar(4000),由于nvarchar是Unicode码。</p><h1 id="SQLServer2000同步复制技术实现步骤"><a href="#SQLServer2000同步复制技术实现步骤" class="headerlink" title="SQLServer2000同步复制技术实现步骤"></a>SQLServer2000同步复制技术实现步骤</h1><h2 id="预备工作"><a href="#预备工作" class="headerlink" title="预备工作"></a>预备工作</h2><p>创建一个同名的 windows 用户</p><ol><li>发布服务器,订阅服务器都创建一个同名的windows用户,并设置相同的密码,做为发布快照文件夹的有效访问用户<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">--管理工具</span><br><span class="line">--计算机管理</span><br><span class="line">--用户和组</span><br><span class="line">--右键用户</span><br><span class="line">--新建用户</span><br><span class="line">--建立一个隶属于administrator组的登陆windows的用户（SynUser）</span><br></pre></td></tr></table></figure></li><li>在发布服务器上,新建一个共享目录,做为发布的快照文件的存放目录,操作:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">我的电脑--D:\ 新建一个目录,名为: PUB</span><br><span class="line">--右键这个新建的目录</span><br><span class="line">--属性--共享</span><br><span class="line">--选择&quot;共享该文件夹&quot;</span><br><span class="line">--通过&quot;权限&quot;按纽来设置具体的用户权限,保证第一步中创建的用户(SynUser) 具有对该文件夹的所有权限</span><br><span class="line">--确定</span><br></pre></td></tr></table></figure></li><li>设置SQL代理(SQLSERVERAGENT)服务的启动用户(发布/订阅服务器均做此设置)<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">开始--程序--管理工具--服务</span><br><span class="line">--右键SQLSERVERAGENT</span><br><span class="line">--属性--登陆--选择&quot;此账户&quot;</span><br><span class="line">--输入或者选择第一步中创建的windows登录用户名（SynUser）</span><br><span class="line">--&quot;密码&quot;中输入该用户的密码</span><br></pre></td></tr></table></figure></li><li>设置SQL Server身份验证模式,解决连接时的权限问题(发布/订阅服务器均做此设置)<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">企业管理器</span><br><span class="line">--右键SQL实例--属性</span><br><span class="line">--安全性--身份验证</span><br><span class="line">--选择&quot;SQL Server 和 Windows&quot;</span><br><span class="line">--确定</span><br></pre></td></tr></table></figure></li><li>在发布服务器和订阅服务器上互相注册企业管理器<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">--右键SQL Server组</span><br><span class="line">--新建SQL Server注册...</span><br><span class="line">--下一步--可用的服务器中,输入你要注册的远程服务器名 --添加</span><br><span class="line">--下一步--连接使用,选择第二个&quot;SQL Server身份验证&quot;</span><br><span class="line">--下一步--输入用户名和密码（SynUser）</span><br><span class="line">--下一步--选择SQL Server组,也可以创建一个新组</span><br><span class="line">--下一步--完成</span><br></pre></td></tr></table></figure></li><li>对于只能用IP,不能用计算机名的,为其注册服务器别名（此步在实施中没用到）(在连接端配置,比如,在订阅服务器上配置的话,服务器名称中输入的是发布服务器的IP)<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">开始--程序--Microsoft SQL Server--客户端网络实用工具</span><br><span class="line">--别名--添加</span><br><span class="line">--网络库选择&quot;tcp&#x2F;ip&quot;--服务器别名输入SQL服务器名</span><br><span class="line">--连接参数--服务器名称中输入SQL服务器ip地址</span><br><span class="line">--如果你修改了SQL的端口,取消选择&quot;动态决定端口&quot;,并输入对应的端口号</span><br></pre></td></tr></table></figure><h2 id="正式配置"><a href="#正式配置" class="headerlink" title="正式配置"></a>正式配置</h2><h3 id="配置发布服务器"><a href="#配置发布服务器" class="headerlink" title="配置发布服务器"></a>配置发布服务器</h3>打开企业管理器，在发布服务器（B、C、D）上执行以下步骤:</li><li>从[工具]下拉菜单的[复制]子菜单中选择[配置发布、订阅服务器和分发]出现配置发布和分发向导</li><li>[下一步] 选择分发服务器 可以选择把发布服务器自己作为分发服务器或者其他sql的服务器（选择自己）</li><li>[下一步] 设置快照文件夹 采用默认\servername\Pub</li><li>[下一步] 自定义配置</li></ol><p>可以选择:是,让我设置分发数据库属性启用发布服务器或设置发布设置<br>否,使用下列默认设置（推荐）</p><ol start="5"><li>[下一步] 设置分发数据库名称和位置 采用默认值</li><li>[下一步] 启用发布服务器 选择作为发布的服务器</li><li>[下一步] 选择需要发布的数据库和发布类型</li><li>[下一步] 选择注册订阅服务器</li><li>[下一步] 完成配置</li></ol><h3 id="创建出版物"><a href="#创建出版物" class="headerlink" title="创建出版物"></a>创建出版物</h3><p>发布服务器B、C、D上</p><ol><li>从[工具]菜单的[复制]子菜单中选择[创建和管理发布]命令</li><li>选择要创建出版物的数据库，然后单击[创建发布]</li><li>在[创建发布向导]的提示对话框中单击[下一步]系统就会弹出一个对话框。对话框上的内容是复制的三个类型。我们现在选第一个也就是默认的快照发布(其他两个大家可以去看看帮助)</li><li>单击[下一步]系统要求指定可以订阅该发布的数据库服务器类型,</li></ol><p>SQLSERVER允许在不同的数据库如 orACLE或ACCESS之间进行数据复制。<br>但是在这里我们选择运行”SQL SERVER 2000”的数据库服务器</p><ol start="5"><li>单击[下一步]系统就弹出一个定义文章的对话框也就是选择要出版的表</li></ol><p>注意: 如果前面选择了事务发布 则再这一步中只能选择带有主键的表</p><ol start="6"><li>选择发布名称和描述</li><li>自定义发布属性 向导提供的选择:</li></ol><ul><li>是 我将自定义数据筛选,启用匿名订阅和或其他自定义属性</li><li>否 根据指定方式创建发布 （建议采用自定义的方式）</li></ul><ol start="8"><li>[下一步] 选择筛选发布的方式</li><li>[下一步] 可以选择是否允许匿名订阅</li></ol><p>如果选择署名订阅,则需要在发布服务器上添加订阅服务器</p><ol><li>[工具]-&gt;[复制]-&gt;[配置发布、订阅服务器和分发的属性]-&gt;[订阅服务器] 中添加</li></ol><ul><li>否则在订阅服务器上请求订阅时会出现的提示:改发布不允许匿名订阅</li></ul><p>如果仍然需要匿名订阅则用以下解决办法<br>[企业管理器]-&gt;[复制]-&gt;[发布内容]-&gt;[属性]-&gt;[订阅选项] 选择允许匿名请求订阅</p><p>如果选择匿名订阅,则配置订阅服务器时不会出现以上提示<br>[下一步] 设置快照 代理程序调度</p><p>[下一步] 完成配置</p><p>当完成出版物的创建后创建出版物的数据库也就变成了一个共享数据库</p><p>有数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">srv1.库名..author有字段:id,name,phone,</span><br><span class="line">srv2.库名..author有字段:id,name,telphone,adress</span><br></pre></td></tr></table></figure><p>要求：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">srv1.库名..author增加记录则srv1.库名..author记录增加</span><br><span class="line"></span><br><span class="line">rv1.库名..author的phone字段更新，则srv1.库名..author对应字段t&gt;elphone更新</span><br><span class="line">*&#x2F;</span><br></pre></td></tr></table></figure><h2 id="大致的处理步"><a href="#大致的处理步" class="headerlink" title="大致的处理步"></a>大致的处理步</h2><p>创建连接服务器</p><ol><li>在 srv1 上创建连接服务器,以便在 srv1 中操作 srv2,实现同步<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">exec sp_addlinkedserver 'srv2','','SQLOLEDB','srv2的sql实例名或ip'</span><br><span class="line">exec sp_addlinkedsrvlogin 'srv2','false',null,'用户名','密码'</span><br><span class="line">go</span><br></pre></td></tr></table></figure></li><li>在 srv1 和 srv2 这两台电脑中,启动 msdtc(分布式事务处理服务),并且设置为自动启动</li></ol><p>我的电脑–控制面板–管理工具–服务–右键 Distributed Transaction Coordinator–属性–启动–并将启动类型设置为自动启动<br>go</p><ul><li>然后创建一个作业定时调用上面的同步处理存储过程就行了</li></ul><p>企业管理器</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">--管理</span><br><span class="line">--SQL Server代理</span><br><span class="line">--右键作业</span><br><span class="line">--新建作业</span><br><span class="line">--&quot;常规&quot;项中输入作业名称</span><br><span class="line">--&quot;步骤&quot;项</span><br><span class="line">--新建</span><br><span class="line">--&quot;步骤名&quot;中输入步骤名</span><br><span class="line">--&quot;类型&quot;中选择&quot;Transact-SQL 脚本(TSQL)&quot;</span><br><span class="line">--&quot;数据库&quot;选择执行命令的数据库</span><br><span class="line">--&quot;命令&quot;中输入要执行的语句: exec p_process</span><br><span class="line">--确定</span><br><span class="line">--&quot;调度&quot;项</span><br><span class="line">--新建调度</span><br><span class="line">--&quot;名称&quot;中输入调度名称</span><br><span class="line">--&quot;调度类型&quot;中选择你的作业执行安排</span><br><span class="line">--如果选择&quot;反复出现&quot;</span><br><span class="line">--点&quot;更改&quot;来设置你的时间安排</span><br></pre></td></tr></table></figure><p>然后将SQL Agent服务启动,并设置为自动启动,否则你的作业不会被执行</p><ul><li><p>设置方法:</p><p>我的电脑–控制面板–管理工具–服务–右键 SQLSERVERAGENT–属性–启动类型–选择”自动启动”–确定.</p></li></ul><p>-3.实现同步处理的方法2,定时同步</p><ul><li><p>在srv1中创建如下的同步处理存储过程</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">create proc p_process</span><br><span class="line">as</span><br><span class="line">&#96;</span><br></pre></td></tr></table></figure></li><li><p>更新修改过的数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> b <span class="keyword">set</span> <span class="keyword">name</span>=i.name,telphone=i.telphone</span><br><span class="line"><span class="keyword">from</span> srv2.库名.dbo.author b,author i</span><br><span class="line"><span class="keyword">where</span> b.id=i.id <span class="keyword">and</span></span><br><span class="line">(b.name &lt;&gt; i.name <span class="keyword">or</span> b.telphone &lt;&gt; i.telphone)</span><br></pre></td></tr></table></figure></li><li><p>插入新增的数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> srv2.库名.dbo.author(<span class="keyword">id</span>,<span class="keyword">name</span>,telphone)</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">name</span>,telphone <span class="keyword">from</span> author i</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span>(</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> srv2.库名.dbo.author <span class="keyword">where</span> <span class="keyword">id</span>=i.id)</span><br></pre></td></tr></table></figure><ul><li>删除已经删除的数据(如果需要的话)<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> b</span><br><span class="line"><span class="keyword">from</span> srv2.库名.dbo.author b</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span>(</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> author <span class="keyword">where</span> <span class="keyword">id</span>=b.id)</span><br><span class="line"><span class="keyword">go</span></span><br></pre></td></tr></table></figure></li></ul></li></ul></div><blockquote class="post-copyright"><div class="content"><span class="post-time">最后更新时间：<time datetime="2021-08-11T07:58:51.119Z" itemprop="dateUpdated">2021-08-11 15:58:51</time></span><br>原始链接：<a href="/posts/SQL-Command.html" target="_blank" rel="external">https://ivitan.com/posts/SQL-Command.html</a></div><footer><a href="https://ivitan.com"><img src="/img/ivitan.png" alt="VITAN"> VITAN</a></footer></blockquote><div class="page-reward"><a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a></div><div class="post-footer"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SQL/" rel="tag">SQL</a></li></ul></div><div class="post-ads"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9318335501008303" data-ad-slot="8390341665" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div><nav class="post-nav flex-row flex-justify-between"><div class="waves-block waves-effect prev"><a href="/posts/SQL-Select.html" id="post-prev" class="post-nav-link"><div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div><h4 class="title">SQL Select 语句</h4></a></div><div class="waves-block waves-effect next"><a href="/posts/Java-variable-types.html" id="post-next" class="post-nav-link"><div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div><h4 class="title">Java 变量类型</h4></a></div></nav><div class="comments vcomment" id="comments"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var GUEST_INFO=["nick","mail","link"],guest_info="nick,mail,link".split(",").filter((function(e){return GUEST_INFO.indexOf(e)>-1}));new Valine({el:"#comments",notify:!1,verify:!1,appId:"D33WPBHpBw2CjwdWpFvpUhDm-MdYXbMMI",appKey:"MzQtKvSeVPU4nS4ljd3zlbMp",avatar:"wavatar",placeholder:"Just go go.",guest_info:0==guest_info.length?GUEST_INFO:guest_info,pageSize:"10"})</script></article><div id="reward" class="page-modal reward-lay"><a class="close" href="javascript:;"><i class="icon icon-close"></i></a><h3 class="reward-title"><i class="icon icon-quote-left"></i> 感谢支持 <i class="icon icon-quote-right"></i></h3><div class="reward-content"><div class="reward-code"><img id="rewardCode" src="/img/wechat.png" alt="打赏二维码"></div><label class="reward-toggle"><input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/wechat.png" data-alipay="/img/alipay.png"><div class="reward-toggle-ctrol"><span class="reward-toggle-item wechat">微信</span> <span class="reward-toggle-item switch" id="switvh">切换</span> <span class="reward-toggle-item alipay">支付宝</span></div></label></div></div><script src="//unpkg.com/jquery@latest/dist/jquery.min.js"></script><script src="/js/clipboard.min.js?v=1.8.5"></script><script src="/js/copy.min.js?v=1.8.5"></script></div><footer class="footer"><div class="top"><p><span id="busuanzi_container_site_uv" style="display:none"><i class="icon icon-user"></i><span id="busuanzi_value_site_uv"></span> </span><span id="busuanzi_container_site_pv" style="display:none"><i class="icon icon-eye"></i><span id="busuanzi_value_site_pv"></span></span></p><p><span>VITAN &copy; 2017 - 2021</span> <span>Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/ivitan/indigo" target="_blank">Indigo</a></span></p></div><div class="bottom"><p><span><a href="/xml/atom.xml" target="_blank" class="rss" title="RSS"><i class="icon icon-lg icon-rss"></i></a></span> <span>内容遵循 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0 协议</a></span></p></div></footer></main><div class="mask" id="mask"></div><a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a><script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script><script>var BLOG={ROOT:"/",SHARE:!1,REWARD:!0}</script><script src="/js/main.min.js?v=1.8.5"></script><div class="search-panel" id="search-panel"><ul class="search-result" id="search-result"></ul></div><template id="search-tpl"><li class="item"><a href="{path}" class="waves-block waves-effect"><div class="title ellipsis" title="{title}">{title}</div><div class="flex-row flex-middle"><div class="tags ellipsis">{tags}</div><time class="flex-col time">{date}</time></div></a></li></template><script src="/js/search.min.js?v=1.8.5" async></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>